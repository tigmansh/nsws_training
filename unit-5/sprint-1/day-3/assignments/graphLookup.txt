db.categories.aggregate([ { $graphLookup: { from: "categories", startWith: "$_id", connectFromField: "_id", connectToField: "parent", as: "hierarchy" } }, { $unwind: "$hierarchy" }, { $group: { _id: "$hierarchy._id", name: { $last: "$hierarchy.name" }, count: { $sum: 1 } } }, { $sort: { _id: 1 } }, { $group: { _id: null, total: { $sum: "$count" }, categories: { $push: "$$ROOT" } } }])